<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Discovery Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Music Discovery</h1>
            <p class="text-lg text-gray-600 mt-2">Find new tracks, artists, and build playlists.</p>
        </header>

        <!-- API Key Input -->
        <div id="api-key-section" class="card p-6 mb-8">
            <h2 class="text-xl font-semibold mb-3">Last.fm API Key</h2>
            <p class="text-gray-600 mb-4">Please enter your Last.fm API key to use the app. You can get one for free from the <a href="https://www.last.fm/api/account/create" target="_blank" class="text-indigo-600 hover:underline">Last.fm API site</a>.</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="password" id="api-key-input" placeholder="Enter your API key" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="save-api-key-btn" class="btn btn-primary">Save Key</button>
            </div>
        </div>

        <main id="main-content" class="hidden">
            <!-- Search Section -->
            <div class="card p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Search by Genre -->
                    <div>
                        <label for="genre-input" class="block text-sm font-medium text-gray-700 mb-1">Search by Genre</label>
                        <div class="flex gap-3">
                            <input type="text" id="genre-input" placeholder="e.g., electronic, 80s" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="search-genre-btn" class="btn btn-primary">Search</button>
                        </div>
                    </div>
                    <!-- Find Similar Artists -->
                    <div>
                        <label for="artist-input" class="block text-sm font-medium text-gray-700 mb-1">Find Similar Artists</label>
                        <div class="flex gap-3">
                            <input type="text" id="artist-input" placeholder="e.g., Daft Punk" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="find-similar-btn" class="btn btn-primary">Find</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="card p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4" id="results-title">Results</h2>
                <div id="loader" class="hidden mx-auto my-4 loader"></div>
                <ul id="results-list" class="space-y-3">
                    <!-- Results will be injected here -->
                </ul>
            </div>

            <!-- Playlist Section -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4">Top 10 Playlist</h2>
                <p class="text-gray-600 mb-4">Enter an artist's name to build their Top 10 playlist and export it as a CSV file.</p>
                 <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="playlist-artist-input" placeholder="Artist for playlist" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="build-playlist-btn" class="btn btn-primary">Build & Export</button>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-10 text-gray-500 text-sm">
            <p>Powered by the Last.fm API</p>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_KEY_INPUT = document.getElementById('api-key-input');
            const SAVE_API_KEY_BTN = document.getElementById('save-api-key-btn');
            const API_KEY_SECTION = document.getElementById('api-key-section');
            const MAIN_CONTENT = document.getElementById('main-content');
            
            const SEARCH_GENRE_BTN = document.getElementById('search-genre-btn');
            const FIND_SIMILAR_BTN = document.getElementById('find-similar-btn');
            const BUILD_PLAYLIST_BTN = document.getElementById('build-playlist-btn');

            const GENRE_INPUT = document.getElementById('genre-input');
            const ARTIST_INPUT = document.getElementById('artist-input');
            const PLAYLIST_ARTIST_INPUT = document.getElementById('playlist-artist-input');

            const LOADER = document.getElementById('loader');
            const RESULTS_LIST = document.getElementById('results-list');
            const RESULTS_TITLE = document.getElementById('results-title');

            let apiKey = localStorage.getItem('lastfm_api_key');
            const BASE_URL = "https://ws.audioscrobbler.com/2.0/";

            // --- App Initialization ---
            const checkApiKey = () => {
                apiKey = localStorage.getItem('lastfm_api_key');
                if (apiKey) {
                    API_KEY_SECTION.classList.add('hidden');
                    MAIN_CONTENT.classList.remove('hidden');
                } else {
                    API_KEY_SECTION.classList.remove('hidden');
                    MAIN_CONTENT.classList.add('hidden');
                }
            };
            
            SAVE_API_KEY_BTN.addEventListener('click', () => {
                const key = API_KEY_INPUT.value.trim();
                if (key) {
                    localStorage.setItem('lastfm_api_key', key);
                    checkApiKey();
                } else {
                    alert('Please enter a valid API key.');
                }
            });

            // --- API Fetch Logic ---
            const makeApiRequest = async (params) => {
                if (!apiKey) {
                    alert("API Key is not set.");
                    return null;
                }
                
                const urlParams = new URLSearchParams({
                    ...params,
                    api_key: apiKey,
                    format: 'json'
                });

                showLoader(true);
                RESULTS_LIST.innerHTML = '';

                try {
                    const response = await fetch(`${BASE_URL}?${urlParams}`);
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    RESULTS_LIST.innerHTML = `<li class="text-red-500">Failed to fetch data. Check the console for details.</li>`;
                    return null;
                } finally {
                    showLoader(false);
                }
            };
            
            // --- UI Update Logic ---
            const showLoader = (isLoading) => {
                LOADER.classList.toggle('hidden', !isLoading);
            };

            const displayTracks = (tracks) => {
                RESULTS_TITLE.textContent = "Top Tracks";
                if (!tracks || tracks.length === 0) {
                    RESULTS_LIST.innerHTML = '<li>No tracks found.</li>';
                    return;
                }
                RESULTS_LIST.innerHTML = tracks.map(track => `
                    <li class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${track.name}</p>
                            <p class="text-sm text-gray-500">${track.artist.name}</p>
                        </div>
                        <a href="${track.url}" target="_blank" class="text-indigo-600 hover:underline text-sm">Listen</a>
                    </li>
                `).join('');
            };

            const displayArtists = (artists) => {
                RESULTS_TITLE.textContent = "Similar Artists";
                if (!artists || artists.length === 0) {
                    RESULTS_LIST.innerHTML = '<li>No similar artists found.</li>';
                    return;
                }
                RESULTS_LIST.innerHTML = artists.map(artist => `
                    <li class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                        <p class="font-semibold">${artist.name}</p>
                        <a href="${artist.url}" target="_blank" class="text-indigo-600 hover:underline text-sm">View</a>
                    </li>
                `).join('');
            };

            // --- Event Handlers ---
            SEARCH_GENRE_BTN.addEventListener('click', async () => {
                const genre = GENRE_INPUT.value.trim();
                if (!genre) return;
                const data = await makeApiRequest({ method: 'tag.gettoptracks', tag: genre, limit: 10 });
                if (data && data.tracks) {
                    displayTracks(data.tracks.track);
                }
            });
            
            FIND_SIMILAR_BTN.addEventListener('click', async () => {
                const artist = ARTIST_INPUT.value.trim();
                if (!artist) return;
                const data = await makeApiRequest({ method: 'artist.getsimilar', artist: artist, limit: 10 });
                 if (data && data.similarartists) {
                    displayArtists(data.similarartists.artist);
                }
            });

            BUILD_PLAYLIST_BTN.addEventListener('click', async () => {
                const artist = PLAYLIST_ARTIST_INPUT.value.trim();
                if (!artist) return;
                const data = await makeApiRequest({ method: 'artist.gettoptracks', artist: artist, limit: 10 });
                if (data && data.toptracks && data.toptracks.track.length > 0) {
                    const tracks = data.toptracks.track;
                    exportPlaylistToCsv(tracks, `${artist}_top_10.csv`);
                } else {
                    alert(`Could not fetch top tracks for ${artist}.`);
                }
            });

            const exportPlaylistToCsv = (tracks, filename) => {
                const header = ['name', 'artist', 'url'];
                const rows = tracks.map(track => [
                    `"${track.name.replace(/"/g, '""')}"`,
                    `"${track.artist.name.replace(/"/g, '""')}"`,
                    track.url
                ]);
                
                const csvContent = "data:text/csv;charset=utf-8," 
                    + [header.join(','), ...rows.join('\n')].join('\n');
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Initial check when page loads
            checkApiKey();
        });
    </script>
</body>
</html>
